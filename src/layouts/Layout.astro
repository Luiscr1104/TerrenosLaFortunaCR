---
import Header from '../components/Header.astro';
import '../styles/global.css';
import Footer from '../components/Footer.astro';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  lang?: string; // default 'en'
}

const {
  title = 'La Fortuna Real Estate | Luxury Homes & Land in Costa Rica Paradise',
  description = `Premium land parcels and turnkey homes for sale in La Fortuna, Costa Rica. Secure, verified purchases for international buyers. Invest in Arenal’s most exclusive locations.`,
  image = '/images/og-image.jpg',
  lang = 'en',
} = Astro.props;

const isProd = import.meta.env.MODE === 'production';
const GA_ID = import.meta.env.PUBLIC_GA_ID; // opcional
const site = Astro.site?.href?.replace(/\/$/, '') ?? '';
const canonicalURL = Astro.site ? new URL(Astro.url.pathname, Astro.site).href : '';
const ogImageUrl = Astro.site ? new URL(image, Astro.site).href : image;

// WhatsApp: poné tu número con código país (ej. +50688887777)
const WHATSAPP_NUMBER = '+50612345678';
const waText = encodeURIComponent(
  `Hello! I'm interested in your luxury properties in La Fortuna, Costa Rica. Could we schedule a video tour?`
);
const waHref = `https://wa.me/${WHATSAPP_NUMBER.replace(/\D/g, '')}?text=${waText}`;

// JSON-LD (WebSite + RealEstateAgent)
const jsonLd = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'WebSite',
      '@id': `${site}/#website`,
      url: site || undefined,
      name: 'Terrenos La Fortuna CR',
      inLanguage: 'en',
      potentialAction: {
        '@type': 'SearchAction',
        target: `${site}/en/search?q={search_term_string}`,
        'query-input': 'required name=search_term_string',
      },
    },
    {
      '@type': 'RealEstateAgent',
      '@id': `${site}/#realestate`,
      name: 'Terrenos La Fortuna CR',
      url: site || undefined,
      image: ogImageUrl,
      address: {
        '@type': 'PostalAddress',
        addressCountry: 'CR',
        addressRegion: 'Alajuela',
        addressLocality: 'La Fortuna',
      },
      areaServed: ['United States', 'Canada', 'Germany', 'Switzerland'],
      availableLanguage: ['en', 'es'],
      telephone: WHATSAPP_NUMBER,
      sameAs: [
        // agrega tus redes si querés
      ],
    },
  ],
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <meta name="theme-color" content="#0f172a" />
    {!isProd && <meta name="robots" content="noindex,nofollow" />}

    <!-- Canonical -->
    {canonicalURL && <link rel="canonical" href={canonicalURL} />}

    <!-- Hreflang (inglés principal; agrega/es-cl según tu ruta en español) -->
    <link rel="alternate" hrefLang="en" href={canonicalURL} />
    <link rel="alternate" hrefLang="es-CR" href={canonicalURL.replace('/en/', '/')} />
    <link rel="alternate" hrefLang="x-default" href={canonicalURL} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    {canonicalURL && <meta property="og:url" content={canonicalURL} />}
    <meta property="og:site_name" content="Terrenos La Fortuna CR" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    {canonicalURL && <meta name="twitter:url" content={canonicalURL} />}
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    {ogImageUrl && <meta name="twitter:image" content={ogImageUrl} />}

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <!-- Structured Data -->
    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>

    <!-- GA4 (opcional) -->
    {GA_ID && (
      <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
        <script>
          {`
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${GA_ID}', { anonymize_ip: true });
          `}
        </script>
      </>
    )}

    <title>{title}</title>
  </head>
  <body class="min-h-dvh bg-white text-neutral-900 antialiased">
    <Header />
    <slot />
    <Footer />

    <!-- WhatsApp Float Button (en inglés, internacional) -->
    <a
      href={waHref}
      target="_blank"
      rel="noopener noreferrer"
      class="fixed bottom-6 right-6 z-50 bg-green-500 text-white p-4 rounded-full shadow-2xl hover:bg-green-600 transition-all duration-300 hover:scale-110 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-green-600"
      aria-label="Contact via WhatsApp"
    >
      <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884"/>
      </svg>
    </a>

    <!-- (Opcional) Evento de tracking del botón WA -->
    <script>
      {`
        const wa = document.currentScript?.previousElementSibling;
        if (wa && window.gtag) {
          wa.addEventListener('click', () => {
            gtag('event', 'click_whatsapp', { location: 'floating_button', page: window.location.pathname });
          });
        }
      `}
    </script>
  </body>
</html>
